var express = require("express");
var passport = require("passport");

var routes = function(db) {
	var authRouter = express.Router();

	authRouter.route("/google")
        .get(function (req, res, next) {
                    console.log("***********************##################get called!#########################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");

            /*
            if (!req.session.userid) {
                req.session.redirectTo = '/account';
                res.redirect('/login');
            } else {
                next();
            }
            */

            //req.session.redirectTo = "/account";
            next();
        })
		.get(passport.authenticate('google', {
        	scope: ['https://www.googleapis.com/auth/userinfo.profile',
            'https://www.googleapis.com/auth/userinfo.email']
    	}), function(req, res) {
                    console.log("***********************##################google#########################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
        });

	authRouter.route('/google/callback')

    	.get(passport.authenticate('google', {
        	//successRedirect: '/user/',
        	failure: '/error/'
    	}), function(req, res) {
            console.log("in google/callback function, req.session.redirectTo is " + req.session.redirectTo);
            if (req.session.redirectTo) {
                console.log("redireting to " + req.session.redirectTo);
                res.redirect(req.session.redirectTo);
            }
            //res.redirect("/");
            /*
            console.log("***********************#callback#################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            console.log("***********************########################################################");
            */
        });

	return authRouter;
};

module.exports = routes;